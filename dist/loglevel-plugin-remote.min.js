"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var CIRCULAR_ERROR_MESSAGE,_regenerator=_interopRequireDefault(require("@babel/runtime/regenerator")),_asyncToGenerator2=_interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator")),_typeof2=_interopRequireDefault(require("@babel/runtime/helpers/typeof")),win=self;if(!win)throw new Error("Plugin for browser usage only");function tryStringify(e){try{return JSON.stringify(e)}catch(e){if(!CIRCULAR_ERROR_MESSAGE)try{var t={};t.a=t,JSON.stringify(t)}catch(e){CIRCULAR_ERROR_MESSAGE=e.message}if(e.message===CIRCULAR_ERROR_MESSAGE)return"[Circular]";throw e}}function getConstructorName(e){if(!Object.getOwnPropertyDescriptor||!Object.getPrototypeOf)return Object.prototype.toString.call(e).slice(8,-1);for(;e;){var t=Object.getOwnPropertyDescriptor(e,"constructor");if(void 0!==t&&"function"==typeof t.value&&""!==t.value.name)return t.value.name;e=Object.getPrototypeOf(e)}return""}function interpolate(e){var t="",r=0;return e.length>1&&"string"==typeof e[0]&&(t=(t=e[0].replace(/(%?)(%([sdjo]))/g,(function(t,n,o,a){if(!n){var i=e[r+=1],l="";switch(a){case"s":l+=i;break;case"d":l+=+i;break;case"j":l=tryStringify(i);break;case"o":var c=tryStringify(i);"{"!==c[0]&&"["!==c[0]&&(c="<".concat(c,">")),l=getConstructorName(i)+c}return l}return t}))).replace(/%{2,2}/g,"%"),r+=1),e.length>r&&(t&&(t+=" "),t+=e.slice(r).join(" ")),t}var hasOwnProperty=Object.prototype.hasOwnProperty;function assign(){for(var e={},t=0;t<arguments.length;t+=1){var r=Object(arguments[t]);for(var n in r)hasOwnProperty.call(r,n)&&(e[n]="object"!==(0,_typeof2.default)(r[n])||Array.isArray(r[n])?r[n]:assign(e[n],r[n]))}return e}function getStacktrace(){try{throw new Error}catch(e){return e.stack}}function Queue(e){var t=this,r=[],n=[];this.length=function(){return r.length},this.sent=function(){return n.length},this.push=function(t){r.push(t),r.length>e&&r.shift()},this.send=function(){return n.length||(n=r,r=[]),n},this.confirm=function(){n=[],t.content=""},this.fail=function(){var o=1+r.length+n.length-e;o>0&&(n.splice(0,o),r=n.concat(r),t.confirm())}}var loglevel,originalFactory,pluginFactory,hasStacktraceSupport=!!getStacktrace();function plain(e){return"[".concat(e.timestamp,"] ").concat(e.level.label.toUpperCase()).concat(e.logger?" (".concat(e.logger,")"):"",": ").concat(e.message).concat(e.stacktrace?"\n".concat(e.stacktrace):"")}function json(e){return e.level=e.level.label,e}function setToken(){throw new Error("You can't set token for a not appled plugin")}function sleep(e){return new Promise((function(t){return setTimeout(t,e)}))}var save=win.remote,defaultCapacity=500,defaults={url:"/logger",method:"POST",headers:{},tokenlabel:"",token:"",onUnauthorized:function(){},timeout:0,interval:1e3,level:"trace",backoff:{multiplier:2,jitter:.1,limit:3e4},capacity:0,stacktrace:{levels:["trace","warn","error"],depth:3,excess:0},timestamp:function(){return(new Date).toISOString()},format:plain},remote={noConflict:function(){return win.remote===remote&&(win.remote=save),remote},plain:plain,json:json,apply:function(e,t){if(!e||!e.getLogger)throw new TypeError("Argument is not a root loglevel object");if(loglevel)throw new Error("You can assign a plugin only one time");if(!win.XMLHttpRequest)return e;loglevel=e;var r=assign(defaults,t);r.capacity=r.capacity||defaultCapacity;var n,o,a=r.backoff,i="object"===(0,_typeof2.default)(a)?function(e){var t=e*a.multiplier;return t>a.limit&&(t=a.limit),t+=t*a.jitter*Math.random()}:a,l=r.interval,c=!1,u=!1,s=new Queue(r.capacity);function f(){return p.apply(this,arguments)}function p(){return(p=(0,_asyncToGenerator2.default)(_regenerator.default.mark((function e(){var t,a,p,g,v,h,y;return _regenerator.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(h=function(e){e||(l=i(l||1),s.fail()),u=!0,win.setTimeout((function(){u=!1,f()}),l)},!u&&!c&&void 0!==r.token){e.next=3;break}return e.abrupt("return");case 3:if(s.sent()){e.next=8;break}if(s.length()){e.next=6;break}return e.abrupt("return");case 6:t=s.send(),s.content=o?'{"logs":['.concat(t.join(","),"]}"):t.join("\n");case 8:if(""!==r.token){e.next=13;break}return e.next=11,sleep(5e3);case 11:return r.onUnauthorized(),e.abrupt("return");case 13:for(g in c=!0,(a=new win.XMLHttpRequest).open(r.method,r.url,!0),a.setRequestHeader("Content-Type",n),r.token&&!r.tokenlabel?a.setRequestHeader("Authorization","Bearer ".concat(r.token)):r.token&&r.tokenlabel&&a.setRequestHeader("".concat(r.tokenlabel),"".concat(r.token)),p=r.headers)hasOwnProperty.call(p,g)&&(v=p[g])&&a.setRequestHeader(g,v);r.timeout&&(y=win.setTimeout((function(){c=!1,a.abort(),h()}),r.timeout)),a.onreadystatechange=function(){if(4===a.readyState)if(c=!1,win.clearTimeout(y),200===a.status)l=r.interval,s.confirm(),h(!0);else{if(401===a.status){var e=r.token;r.token=void 0,r.onUnauthorized(e)}h()}},a.send(s.content);case 23:case"end":return e.stop()}}),e)})))).apply(this,arguments)}return originalFactory=e.methodFactory,pluginFactory=function(e,t,a){var i=originalFactory(e,t,a),l=hasStacktraceSupport&&r.stacktrace.levels.some((function(t){return t===e})),c=loglevel.levels[e.toUpperCase()],u=c>=loglevel.levels[r.level.toUpperCase()];return function(){for(var t=arguments.length,p=new Array(t),g=0;g<t;g++)p[g]=arguments[g];if(u||"Analytics"===a){var v=r.timestamp(),h=l?getStacktrace():"";if(h){var y=h.split("\n");y.splice(0,r.stacktrace.excess+3);var m=r.stacktrace.depth;if(m&&y.length!==m+1){var d=y.splice(0,m);h=d.join("\n"),y.length&&(h+="\n    and ".concat(y.length," more"))}else h=y.join("\n")}var k=r.format({message:interpolate(p),level:{label:e,value:c},logger:a||"",timestamp:v,stacktrace:h});void 0===o&&(n=(o="string"!=typeof k)?"application/json":"text/plain");var b="";if(o)try{b+=JSON.stringify(k)}catch(e){return i.apply(void 0,p),void loglevel.getLogger("logger").error(e)}else b+=k;s.push(b),f()}"Analytics"!==a&&i.apply(void 0,p)}},e.methodFactory=pluginFactory,e.setLevel(e.getLevel()),remote.setToken=function(e){r.token=e,f()},e},disable:function(){if(!loglevel)throw new Error("You can't disable a not appled plugin");if(pluginFactory!==loglevel.methodFactory)throw new Error("You can't disable a plugin after appling another plugin");loglevel.methodFactory=originalFactory,loglevel.setLevel(loglevel.getLevel()),loglevel=void 0,remote.setToken=setToken},setToken:setToken},_default=remote;exports.default=_default,module.exports=exports.default;